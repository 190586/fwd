var User=function(){return{initialize:function(){var a=this;Login.auth(function(){$(".contentpanel").load("/admin/users-content-panel",function(){$(".sub-menu-user").addClass("active");$(".pageheader-h2-icon").attr("class","pageheader-h2-icon");$(".pageheader-h2-icon").addClass("fa fa-users");$(".pageheader-h2-text").html(" Users");$(".pageheader-module").html("Users");$(".chosen-select").chosen({width:"100%"});$("#formvalidate").validate({submitHandler:function(b){a.saveOrUpdate(b)}});$("#btn-cancel").on("click",function(b){b.preventDefault();$("#userModalForm").modal("hide")});a.loadUser()})})},loadUser:function(){var c="/public/images";if($("#datatable1").length){var e=this;$("#datatable1").dataTable().fnDestroy();$("#datatable1").show();$("#datatable1").dataTable({sAjaxSource:"/api/users",sAjaxDataProp:"_embedded.users",aoColumns:[{mData:null},{mData:"username"},{mData:"fullname"},{mData:"role"},{mData:null,mRender:function(h,g,i){var f='<div align="center"><img src="'+c+"?path="+i.avatarPath+'" style="padding:3px;border:thin solid #dddddd;border-radius:5px;"></div>';return f}},{mData:null,mRender:function(h,f,i){var k=i._links.self.href.split("/");var j=k[k.length-1];var g='<a onclick="User.detailUser('+j+')">Edit</a>';g+='&nbsp;|&nbsp;<a href="#" onclick="if(confirm(\'Are you sure?\')) {User.deleteUser('+j+');}">Delete</a>';return g},bSortable:false}],bServerSide:true,fnServerData:e.serverDataProcessor,fnRowCallback:function(k,i,h,g){var j=i.pageSize;var l=i.pageNum;var f=(l*j+(h+1));$("td:eq(0)",k).html(f);if(!i.active){$(k).css({"background-color":"#ffaabb"})}return k}});var d=$("#datatable1_wrapper");var b=d.find("div[id$=_filter]");var a=' <label><button class="btn btn-sm btn-primary" onclick="User.createNewUser();">Add User</button>';b.append(a)}},serverDataProcessor:function(g,o,e){var m={};for(var f=0;f<o.length;f++){m[o[f].name]=o[f].value}var l=m.iDisplayLength;var b=m.iDisplayStart;var k=(b==0)?0:(b/l);var h=m.iSortCol_0;var j=m.sSortDir_0;var n=m["mDataProp_"+h]!=null?m["mDataProp_"+h]:"idUser";var c=new Array();c.push({name:"size",value:l});c.push({name:"page",value:k});c.push({name:"sort",value:n+","+j});var a=g;if(m.sSearch!=""){a="/api/users/search/all";c.push({name:"q",value:m.sSearch})}var d=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:a,data:c,beforeSend:function(i){i.setRequestHeader("Authorization","Bearer "+d)},success:function(i){i.iTotalRecords=i.page.size;i.iTotalDisplayRecords=i.page.totalElements;$.map(i._embedded.users,function(q,p){q.pageNum=k;q.pageSize=l});e(i)},error:function(i){if(i.status==401){Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()})}else{Notification.show("danger","Failed to load user")}}})},saveOrUpdate:function(c){var f=this;var e={};$(c).serializeArray().map(function(j){e[j.name]=j.value});var b=e.idUser;var i=b===""?"POST":"PUT";var a=b===""?"/api/usercustom":"/api/usercustom/"+b;var h=$("#avatar")[0];var g=new Array("image/jpg","image/jpeg","image/png");if(h.files.length&&$.inArray(h.files[0].type,g)===-1){$('label[for="image"]').html("Accepted formats are only jpg, jpeg and png");$('label[for="image"]').css("display","block")}else{var d=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");this.readImage(h.files,function(j){if(typeof j!=="undefined"){var k=j.replace(/^data:image\/[a-z]+;base64,/,"");e.avatarPath=k;e.avatarChanged=true}e=JSON.stringify(e);$.ajax({dataType:"json",contentType:"application/json",type:i,url:a,data:e,beforeSend:function(l){l.setRequestHeader("Authorization","Bearer "+d)},success:function(l){$("#userModalForm").modal("hide");Notification.show("success","User saved successfully",function(){f.loadUser()})},error:function(l){if(l.status==401){Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()})}else{Notification.show("danger","Failed to save user")}}})})}},createNewUser:function(){$("#header-title-mode").html("Create New");$("#header-title").html("");$("#idUser").val("");$("#username").val("");$("#password").val("");$("#fullname").val("");$("#role").val("");$(".avatar-preview").css("display","none");$("#avatar-image").attr("src","");$("#avatar-fileupload").attr("class","fileupload fileupload-new");$(".fileupload-preview").html("");Notification.hide();$("#userModalForm").modal("show")},detailUser:function(c){var a="/api/users/"+c;var b=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:a,beforeSend:function(d){d.setRequestHeader("Authorization","Bearer "+b)},success:function(d){var f=d._links.self.href.split("/");var e=f[f.length-1];if($.isNumeric(e)){$("#idUser").val(e)}$("#header-title-mode").html("Edit");$("#header-title").html('"'+d.username+'"');$("#username").val(d.username);$("#password").val("*******");$("#fullname").val(d.fullname);$("#role").val(d.role);$("#role").trigger("chosen:updated");if(d.avatarPath!=null&&d.avatarPath!==""){$("#avatar-image").attr("src","/public/images?path="+d.avatarPath);$(".avatar-preview").css("display","block");$("#avatar-fileupload").attr("class","fileupload fileupload-new");$(".fileupload-preview").html("")}else{$(".avatar-preview").css("display","none");$("#avatar-image").attr("src","")}$("#active").val(d.active?"true":"false");$("#active").trigger("chosen:updated");Notification.hide();$("#userModalForm").modal("show")},error:function(d){if(d.status==401){Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()})}else{Notification.show("danger","Failed to load user")}}})},deleteUser:function(d){var c=this;var a="/api/users/"+d;var b=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",contentType:"application/json",type:"DELETE",url:a,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+b)},success:function(e){Notification.show("success","User deleted successfully");c.loadUser()},error:function(e){if(e.status==401){Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()})}else{Notification.show("danger","Failed to delete user")}}})},getUrlParameter:function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)");var b=c.exec(location.search);return b===null?"":decodeURIComponent(b[1].replace(/\+/g," "))},readImage:function(b,d){if(b.length){var c=b[0];var a=new FileReader();a.onload=function(){data=a.result;d(data)};a.readAsDataURL(c)}else{d()}}}}();